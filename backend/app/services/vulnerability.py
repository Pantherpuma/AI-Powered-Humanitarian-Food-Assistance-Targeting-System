"""Lightweight service generating illustrative vulnerability scores."""

from __future__ import annotations

from dataclasses import dataclass
from datetime import datetime
from math import tanh
from random import Random
from typing import Dict, List

REGION_PRIORS: Dict[str, Dict[str, float]] = {
    "unity": {"flood_risk": 0.82, "conflict_intensity": 0.65, "market_volatility": 0.58, "nutrition_gap": 0.71},
    "jonglei": {"flood_risk": 0.76, "conflict_intensity": 0.52, "market_volatility": 0.61, "nutrition_gap": 0.69},
    "wai": {"flood_risk": 0.44, "conflict_intensity": 0.32, "market_volatility": 0.40, "nutrition_gap": 0.48},
}


@dataclass
class VulnerabilityResult:
    region_id: str
    risk_score: float
    risk_level: str
    indicators: Dict[str, float]
    feature_contributions: List[Dict[str, float]]
    updated_at: datetime


def _categorise(score: float) -> str:
    if score >= 0.8:
        return "critical"
    if score >= 0.6:
        return "high"
    if score >= 0.4:
        return "moderate"
    return "stable"


def score_region(region_id: str) -> VulnerabilityResult:
    """Generate a deterministic yet dynamic score for demos."""

    priors = REGION_PRIORS.get(
        region_id.lower(),
        {"flood_risk": 0.55, "conflict_intensity": 0.4, "market_volatility": 0.45, "nutrition_gap": 0.5},
    )
    seed = sum(bytearray(region_id, encoding="utf-8")) + datetime.utcnow().timetuple().tm_yday
    rng = Random(seed)
    climate_anomaly = priors["flood_risk"] + rng.uniform(-0.05, 0.05)
    conflict = priors["conflict_intensity"] + rng.uniform(-0.04, 0.04)
    markets = priors["market_volatility"] + rng.uniform(-0.03, 0.03)
    nutrition = priors["nutrition_gap"] + rng.uniform(-0.05, 0.05)

    weighted_sum = (
        0.35 * climate_anomaly + 0.30 * conflict + 0.2 * nutrition + 0.15 * markets
    )
    risk_score = round(float((tanh(weighted_sum) + 1) / 2), 3)

    feature_contributions = [
        {"name": "climate_anomaly", "weight": round(climate_anomaly - 0.5, 3)},
        {"name": "conflict_intensity", "weight": round(conflict - 0.5, 3)},
        {"name": "nutrition_gap", "weight": round(nutrition - 0.5, 3)},
        {"name": "market_volatility", "weight": round(markets - 0.5, 3)},
    ]

    return VulnerabilityResult(
        region_id=region_id,
        risk_score=min(max(risk_score, 0.0), 1.0),
        risk_level=_categorise(risk_score),
        indicators={
            "climate_anomaly": round(climate_anomaly, 3),
            "conflict_intensity": round(conflict, 3),
            "market_volatility": round(markets, 3),
            "nutrition_gap": round(nutrition, 3),
        },
        feature_contributions=feature_contributions,
        updated_at=datetime.utcnow(),
    )

